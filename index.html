<!DOCTYPE html>
<html lang="en">
<head>
    <title>WebXR Pin Collector</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #f0f0f0;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            overflow: hidden;
        }
        .ar-button {
            background-color: #4A90E2;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 12;
        }
        .ar-button:hover:not(:disabled) {
            background-color: #357ABD;
        }
        .ar-button:active:not(:disabled) {
            transform: scale(0.98);
        }
        #info-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #info {
            padding: 15px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
        }
        #info p {
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 14px;
            text-align: left;
            background-color: #eee;
            padding: 1rem;
            border-radius: 8px;
        }
        #bypass-button {
            margin-top: 15px;
            background-color: #6c757d;
            font-size: 16px;
            padding: 10px 20px;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        #curtain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
            z-index: 10; /* High z-index to cover everything */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .arrow {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            font-size: 48px;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 15px;
            display: none;
            z-index: 10;
            user-select: none;
        }
        #left-arrow { left: 10px; }
        #right-arrow { right: 10px; }
        #tooltip {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 16px;
            z-index: 11;
            display: none;
        }
        #toggle-ar-button {
            pointer-events: auto;
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #E24A4A;
            display: none;
        }
        #radar-container {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        #radar {
            position: relative;
            width: 250px;
            height: 250px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border: 5px solid #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #radar-needle {
            position: absolute;
            width: 4px;
            height: 120px;
            background: #E24A4A;
            bottom: 50%;
            transform-origin: bottom center;
            transform: rotate(0deg);
            transition: transform 0.5s ease-out;
            border-radius: 4px 4px 0 0;
        }
        #ar-activation-button {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            color: white;
            border: 5px solid rgba(255, 255, 255, 0.8);
            cursor: not-allowed;
            position: relative;
            z-index: 2;
            --fill-percentage: 0%;
            background: conic-gradient(#4A90E2 0% var(--fill-percentage), #555 var(--fill-percentage) 100%);
            transition: background 0.5s, box-shadow 0.3s;
        }
        #ar-activation-button:not(:disabled) {
            cursor: pointer;
            box-shadow: 0 0 25px #4A90E2;
        }
        #ar-activation-button:disabled::after {
            content: '...';
            font-size: 50px;
            line-height: 1;
            color: #fff;
        }
        #distance-info {
            font-size: 18px;
            font-weight: 500;
            color: #555;
            background-color: #fff;
            padding: 8px 16px;
            border-radius: 16px;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="curtain">
        <div id="info-container">
            <div id="info">
                <h1>WebXR Pin Collector</h1>
                <p>Waiting for data from parent application...</p>
                <button id="bypass-button" class="ar-button">Play with Test Data</button>
            </div>
        </div>
        <div id="radar-container">
            <div id="radar">
                <div id="radar-needle"></div>
                <button id="ar-activation-button" class="ar-button" disabled></button>
            </div>
            <p id="distance-info">Find the signal source!</p>
        </div>
    </div>
    
    <button id="start-ar-button" class="ar-button" style="display: none;">Start AR</button>
    <button id="toggle-ar-button" class="ar-button">Hide AR</button>

    <div id="overlay">
        <div id="left-arrow" class="arrow">&lt;</div>
        <div id="right-arrow" class="arrow">&gt;</div>
        <div id="tooltip">Rotate around to find the pin!</div>
    </div>

    <script type="module">
        import * as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.min.js';

        // --- Original AR State ---
        let camera, scene, renderer;
        let pin;
        let hitTestSource = null;
        let hitTestSourceRequested = false;
        let pinPlaced = false;
        let currentSession = null;
        let isARVisible = true;
        let raycaster;

        // --- Radar State ---
        const TARGET_RADIUS_METERS = 10;
        const ACTIVATION_RADIUS_METERS = 2;
        let userLocation = null;
        let targetLocation = null;
        let deviceHeading = 0;
        let locationWatchId = null;

        // --- DOM Elements ---
        const leftArrow = document.getElementById('left-arrow');
        const rightArrow = document.getElementById('right-arrow');
        const tooltip = document.getElementById('tooltip');
        const startButton = document.getElementById('start-ar-button');
        const toggleButton = document.getElementById('toggle-ar-button');
        const curtain = document.getElementById('curtain');
        const infoText = document.querySelector('#info p');
        const infoContainer = document.getElementById('info-container');
        const radarContainer = document.getElementById('radar-container');
        const radarNeedle = document.getElementById('radar-needle');
        const activationButton = document.getElementById('ar-activation-button');
        const distanceInfo = document.getElementById('distance-info');
        const bypassButton = document.getElementById('bypass-button');

        // --- MAIN INITIALIZATION ---
        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);

            raycaster = new THREE.Raycaster();
            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
            light.position.set(0.5, 1, 0.25);
            scene.add(light);
            
            toggleButton.addEventListener('click', toggleARVisibility);
            createPin();
            renderer.setAnimationLoop(render);
            window.addEventListener('resize', onWindowResize, false);
            
            // Listen for the bypass button click
            bypassButton.addEventListener('click', beginRadarGame);

            // Listen for data from the parent app
            window.addEventListener('message', (event) => {
                if (event.origin !== window.location.origin) return;
                infoText.textContent = `Tap screen to begin search for:\n${JSON.stringify(event.data.title, null, 2)}`;
                bypassButton.style.display = 'none'; // Hide bypass button when real data is loaded
                document.body.addEventListener('click', beginRadarGame, { once: true });
            });
        }

        // --- RADAR GAME LOGIC ---

        function beginRadarGame() {
            infoContainer.style.display = 'none';
            radarContainer.style.display = 'flex';
            requestLocationAndOrientation();
        }

        function requestLocationAndOrientation() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                        } else {
                            alert('Permission for device orientation was denied.');
                        }
                    }).catch(console.error);
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
            }
            navigator.geolocation.getCurrentPosition(setupInitialState, handleLocationError, { enableHighAccuracy: true });
        }

        function handleOrientation(event) {
            deviceHeading = event.webkitCompassHeading || event.alpha;
        }



        function setupInitialState(position) {
            userLocation = position.coords;
            targetLocation = generateRandomTarget(userLocation, TARGET_RADIUS_METERS);
            locationWatchId = navigator.geolocation.watchPosition(updateRadar, handleLocationError, { enableHighAccuracy: true });
        }

        function updateRadar(position) {
            userLocation = position.coords;
            const distance = calculateDistance(userLocation, targetLocation);
            const bearing = calculateBearing(userLocation, targetLocation);
            const needleRotation = bearing - deviceHeading;
            
            radarNeedle.style.transform = `rotate(${needleRotation}deg)`;
            
            const fillRange = TARGET_RADIUS_METERS - ACTIVATION_RADIUS_METERS;
            const distanceIntoRange = TARGET_RADIUS_METERS - distance;
            let fillPercentage = (distanceIntoRange / fillRange) * 100;
            fillPercentage = Math.max(0, Math.min(100, fillPercentage));

            activationButton.style.setProperty('--fill-percentage', `${fillPercentage}%`);
            distanceInfo.textContent = `Distance: ${Math.round(distance)} meters`;

            if (distance <= ACTIVATION_RADIUS_METERS) {
                activationButton.disabled = false;
                activationButton.textContent = "START";
                activationButton.onclick = onStartAR;
                if (locationWatchId) navigator.geolocation.clearWatch(locationWatchId);
            } else {
                activationButton.disabled = true;
                activationButton.textContent = "";
            }
        }

        // --- WEBXR AR LOGIC ---

        async function onStartAR() {
            radarContainer.style.display = 'none';
            curtain.style.display = 'none';

            try {
                const session = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['hit-test', 'dom-overlay', 'local'],
                    domOverlay: { root: document.getElementById('overlay') }
                });
                onSessionStarted(session);
            } catch (e) {
                console.error("Failed to start AR session:", e);
                alert("Could not start AR session.");
            }
        }

        function onSessionStarted(session) {
            currentSession = session;
            session.addEventListener('end', onSessionEnded);
            session.addEventListener('select', onSelect);
            renderer.xr.setReferenceSpaceType('local');
            renderer.xr.setSession(session);
            
            toggleButton.style.display = 'block';
            toggleButton.textContent = 'Hide AR';
            isARVisible = true;
        }
        
        function onSelect() {
            if (pinPlaced && pin.visible) {
                raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
                const intersects = raycaster.intersectObject(pin, true);
                if (intersects.length > 0) {
                    window.parent.postMessage('AR_ACTIVITY_COMPLETE', window.location.origin);
                    pin.visible = false;
                    setTimeout(() => currentSession.end(), 500);
                }
            }
        }

        function toggleARVisibility() {
            isARVisible = !isARVisible;
            if (isARVisible) {
                curtain.style.display = 'none';
                toggleButton.textContent = 'Hide AR';
            } else {
                curtain.style.display = 'flex';
                infoContainer.style.display = 'none';
                radarContainer.style.display = 'none';
                leftArrow.style.display = 'none';
                rightArrow.style.display = 'none';
                tooltip.style.display = 'none';
                toggleButton.textContent = 'Show AR';
            }
        }

        function onSessionEnded() {
            currentSession.removeEventListener('end', onSessionEnded);
            currentSession.removeEventListener('select', onSelect);
            currentSession = null;
            
            toggleButton.style.display = 'none';
            curtain.style.display = 'flex';
            infoContainer.style.display = 'block';
            infoText.textContent = "Session Ended. Thanks for playing!";

            pin.visible = false;
            pinPlaced = false; 
            leftArrow.style.display = 'none';
            rightArrow.style.display = 'none';
            tooltip.style.display = 'none';
        }

        function createPin() {
            pin = new THREE.Group();
            const headGeometry = new THREE.SphereGeometry(0.05, 32, 32);
            const headMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000 });
            const pinHead = new THREE.Mesh(headGeometry, headMaterial);
            pinHead.position.y = 0.15;
            
            const bodyGeometry = new THREE.CylinderGeometry(0.01, 0.01, 0.15, 32);
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0xcccccc });
            const pinBody = new THREE.Mesh(bodyGeometry, bodyMaterial);
            pinBody.position.y = 0.075;
            
            pin.add(pinHead);
            pin.add(pinBody);
            
            pin.visible = false;
            scene.add(pin);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function render(timestamp, frame) {
            if (frame && isARVisible) {
                const referenceSpace = renderer.xr.getReferenceSpace();
                const session = renderer.xr.getSession();

                if (hitTestSourceRequested === false) {
                    session.requestReferenceSpace('viewer').then((referenceSpace) => {
                        session.requestHitTestSource({ space: referenceSpace }).then((source) => {
                            hitTestSource = source;
                        });
                    });
                    session.addEventListener('end', () => {
                        hitTestSourceRequested = false;
                        hitTestSource = null;
                    });
                    hitTestSourceRequested = true;
                }

                if (hitTestSource && !pinPlaced) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);
                    if (hitTestResults.length > 0) {
                        const hit = hitTestResults[0];
                        const pose = hit.getPose(referenceSpace).transform;
                        
                        const randomX = (Math.random() - 0.5) * 4;
                        const randomZ = (Math.random() - 0.5) * 4;

                        pin.position.set(pose.position.x + randomX, pose.position.y, pose.position.z + randomZ);
                        pin.visible = true;
                        pinPlaced = true;

                        tooltip.style.display = 'block';
                        setTimeout(() => { tooltip.style.display = 'none'; }, 5000);
                    }
                }

                if (pinPlaced && pin.visible) {
                    const pinWorldPosition = pin.getWorldPosition(new THREE.Vector3());
                    const pinInCameraSpace = camera.worldToLocal(pinWorldPosition.clone());

                    if (pinInCameraSpace.z > 0) { 
                        if (pinInCameraSpace.x > 0) {
                            leftArrow.style.display = 'none';
                            rightArrow.style.display = 'block';
                        } else {
                            leftArrow.style.display = 'block';
                            rightArrow.style.display = 'none';
                        }
                    } else { 
                        const pinProjected = pinWorldPosition.clone().project(camera);
                        if (pinProjected.x < -0.9) {
                            leftArrow.style.display = 'block';
                            rightArrow.style.display = 'none';
                        } else if (pinProjected.x > 0.9) {
                            leftArrow.style.display = 'none';
                            rightArrow.style.display = 'block';
                        } else {
                            leftArrow.style.display = 'none';
                            rightArrow.style.display = 'none';
                        }
                    }
                } else {
                    leftArrow.style.display = 'none';
                    rightArrow.style.display = 'none';
                }
            }
            renderer.render(scene, camera);
        }

        // --- UTILITY FUNCTIONS ---
        function generateRandomTarget(coords, radiusMeters) {
            const { latitude, longitude } = coords;
            const latOffset = (Math.random() - 0.5) * (radiusMeters / 111111) * 2;
            const lonOffset = (Math.random() - 0.5) * (radiusMeters / (111111 * Math.cos(latitude * Math.PI / 180))) * 2;
            return { latitude: latitude + latOffset, longitude: longitude + lonOffset };
        }
        function calculateDistance(coords1, coords2) {
            const R = 6371e3;
            const φ1 = coords1.latitude * Math.PI/180;
            const φ2 = coords2.latitude * Math.PI/180;
            const Δφ = (coords2.latitude-coords1.latitude) * Math.PI/180;
            const Δλ = (coords2.longitude-coords1.longitude) * Math.PI/180;
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        function calculateBearing(coords1, coords2) {
            const φ1 = coords1.latitude * Math.PI/180, λ1 = coords1.longitude * Math.PI/180;
            const φ2 = coords2.latitude * Math.PI/180, λ2 = coords2.longitude * Math.PI/180;
            const y = Math.sin(λ2-λ1) * Math.cos(φ2);
            const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2-λ1);
            return (Math.atan2(y, x)*180/Math.PI + 360) % 360;
        }
        function handleLocationError(error) {
            alert(`Location Error: ${error.message}. Please enable location services.`);
            radarContainer.style.display = 'none';
            infoContainer.style.display = 'flex';
            infoText.textContent = `Error: ${error.message}`;
        }
        
        // --- START THE APP ---
        init();

    </script>
</body>
</html>
