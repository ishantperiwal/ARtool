<!DOCTYPE html>
<html>
<head>
    <title>WebXR Hide and Seek</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            background-color: #111;
            color: #fff;
        }
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            z-index: 100;
            display: block;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
        }
        #ar-button {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border: 1px solid #fff;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            font-size: 16px;
            cursor: pointer;
        }
        #ar-button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div id="info">
        <h1>WebXR Hide and Seek</h1>
        <p id="instructions">Point your device at a surface and tap the screen to place the object.</p>
    </div>
    <button id="ar-button" disabled>Start AR</button>
    <div id="message">
        <h2>Object Found!</h2>
        <p>You've successfully found the hidden object.</p>
        <button id="reset-button">Play Again</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Ensure ThreeJS is loaded before starting the app
        if (typeof THREE === 'undefined') {
            document.getElementById('instructions').innerText = 'Error: Could not load three.js';
        } else {
            initializeApp();
        }

        function initializeApp() {
            const instructions = document.getElementById('instructions');
            const arButton = document.getElementById('ar-button');
            const message = document.getElementById('message');
            const resetButton = document.getElementById('reset-button');

            let xrSession = null;
            let xrRefSpace = null;
            let xrHitTestSource = null;

            let gl = null;
            let renderer = null;
            let scene = null;
            let camera = null;

            let reticle = null;
            let hiddenObject = null;
            let placedObject = null;

            let isHider = true; // Start as the hider

            // Check for WebXR support
            if (navigator.xr) {
                navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
                    if (supported) {
                        arButton.disabled = false;
                        arButton.textContent = 'Start Hiding';
                    }
                });
            }

            // Start the AR session
            arButton.addEventListener('click', () => {
                if (xrSession === null) {
                    navigator.xr.requestSession('immersive-ar', {
                        requiredFeatures: ['hit-test'],
                        optionalFeatures: ['dom-overlay'],
                        domOverlay: { root: document.body }
                    }).then(onSessionStarted);
                } else {
                    xrSession.end();
                }
            });

            // Handle session start
            async function onSessionStarted(session) {
                xrSession = session;
                arButton.textContent = 'Stop';

                // Set up the WebGL context and renderer
                const canvas = document.createElement('canvas');
                gl = canvas.getContext('webgl', { xrCompatible: true });
                renderer = new THREE.WebGLRenderer({
                    canvas: canvas,
                    context: gl,
                    alpha: true,
                    antialias: true,
                    powerPreference: 'high-accuracy'
                });
                renderer.autoClear = false;

                // Set up the scene and camera
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera();
                camera.matrixAutoUpdate = false;

                await renderer.xr.setSession(xrSession);
                xrRefSpace = await xrSession.requestReferenceSpace('local');

                // Set up hit testing
                const viewerSpace = await xrSession.requestReferenceSpace('viewer');
                xrHitTestSource = await xrSession.requestHitTestSource({ space: viewerSpace });

                // Create the reticle (the marker for placing objects)
                const reticleGeometry = new THREE.RingGeometry(0.05, 0.06, 32);
                const reticleMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });
                reticle = new THREE.Mesh(reticleGeometry, reticleMaterial);
                reticle.matrixAutoUpdate = false;
                reticle.visible = false;
                scene.add(reticle);

                // Create the object to be hidden
                const objectGeometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);
                const objectMaterial = new THREE.MeshNormalMaterial();
                hiddenObject = new THREE.Mesh(objectGeometry, objectMaterial);

                // Start the render loop
                xrSession.requestAnimationFrame(onXRFrame);

                // Handle screen taps
                xrSession.addEventListener('select', onSelect);

                xrSession.addEventListener('end', () => {
                    xrSession = null;
                    arButton.textContent = 'Start Hiding';
                    if (isHider) {
                        instructions.innerText = 'Now, hand the device to the seeker.';
                        arButton.textContent = 'Start Seeking';
                        isHider = false;
                    } else {
                        instructions.innerText = 'Point your device at a surface and tap the screen to place the object.';
                        arButton.textContent = 'Start Hiding';
                        isHider = true;
                    }
                });
            }

            // Handle each frame of the AR session
            function onXRFrame(time, frame) {
                if (!xrSession) return;

                const session = frame.session;
                session.requestAnimationFrame(onXRFrame);

                const pose = frame.getViewerPose(xrRefSpace);
                if (pose) {
                    renderer.xr.updateCamera(pose);
                    
                    if (isHider && xrHitTestSource) {
                        const hitTestResults = frame.getHitTestResults(xrHitTestSource);
                        if (hitTestResults.length > 0) {
                            const hit = hitTestResults[0];
                            const hitPose = hit.getPose(xrRefSpace);
                            reticle.visible = true;
                            reticle.matrix.fromArray(hitPose.transform.matrix);
                        } else {
                            reticle.visible = false;
                        }
                    }

                    if (!isHider && placedObject) {
                        // Check if the seeker has found the object
                        const distance = camera.position.distanceTo(placedObject.position);
                        if (distance < 0.5) {
                            message.style.display = 'block';
                            xrSession.end();
                        }
                    }

                    renderer.render(scene, camera);
                }
            }

            // Handle screen taps
            function onSelect() {
                if (isHider && reticle.visible) {
                    // Place the object
                    placedObject = hiddenObject.clone();
                    placedObject.position.setFromMatrixPosition(reticle.matrix);
                    scene.add(placedObject);

                    // Save the object's position and orientation to localStorage
                    const position = placedObject.position;
                    const quaternion = placedObject.quaternion;
                    localStorage.setItem('hiddenObject', JSON.stringify({
                        position: [position.x, position.y, position.z],
                        quaternion: [quaternion.x, quaternion.y, quaternion.z, quaternion.w]
                    }));

                    instructions.innerText = 'Object hidden! Tap "Stop" and hand the device to the seeker.';
                    reticle.visible = false;
                }
            }
            
            // Load the hidden object for the seeker
            function loadHiddenObject() {
                const objectData = localStorage.getItem('hiddenObject');
                if (objectData) {
                    const data = JSON.parse(objectData);
                    placedObject = hiddenObject.clone();
                    placedObject.position.fromArray(data.position);
                    placedObject.quaternion.fromArray(data.quaternion);
                    scene.add(placedObject);
                }
            }

            // Reset the game
            resetButton.addEventListener('click', () => {
                localStorage.removeItem('hiddenObject');
                message.style.display = 'none';
                instructions.innerText = 'Point your device at a surface and tap the screen to place the object.';
                arButton.textContent = 'Start Hiding';
                isHider = true;
                placedObject = null;
            });

            // The seeker starts their turn
            arButton.addEventListener('click', () => {
                if (!isHider && xrSession === null) {
                    navigator.xr.requestSession('immersive-ar', {
                        requiredFeatures: ['hit-test'],
                        optionalFeatures: ['dom-overlay'],
                        domOverlay: { root: document.body }
                    }).then(session => {
                        onSessionStarted(session).then(() => {
                            loadHiddenObject();
                            instructions.innerText = 'Look around the room to find the hidden object.';
                        });
                    });
                }
            });
        }
    </script>
</body>
</html>
