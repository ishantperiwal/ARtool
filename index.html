<!DOCTYPE html>
<html lang="en">
<head>
    <title>WebXR AR GPS Pins with Local Storage</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden; /* Prevent scrolling */
        }
        /* The AR container will be hidden initially */
        #ar-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            display: none; /* Hidden by default */
        }
        /* The map container takes the full screen initially */
        #map-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
        #info-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 10; /* Ensure it's on top of map and AR */
            max-width: 300px;
        }
        /* Hide the default AR button created by Three.js */
        #ar-button { display: none !important; }
    </style>
</head>
<body class="bg-black text-white">

    <!-- The AR view will be populated by Three.js -->
    <div id="ar-container"></div>

    <!-- The Map view is the default view -->
    <div id="map-container">
        <div id="map" class="w-full h-full"></div>
        <!-- Button to enter the AR experience -->
        <button id="enter-ar-button" class="absolute bottom-10 left-1/2 -translate-x-1/2 z-10 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transition-transform transform hover:scale-105">
            Go Inside AR
        </button>
    </div>

    <!-- UI Panel for status messages and coordinates -->
    <div id="info-panel">
        <p id="status">Welcome! Loading map...</p>
        <p id="coords">Lat/Lon: N/A</p>
    </div>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.148.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.148.0/examples/jsm/"
            }
        }
    </script>

    <!-- 
      This module script, which defines 'initApp', is placed BEFORE 
      the Google Maps script that calls it. This prevents race condition errors.
    -->
    <script type="module">
        // Three.js Imports
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/webxr/ARButton.js';

        // --- GLOBAL VARIABLES ---
        let camera, scene, renderer;
        let controller;
        let reticle;
        let hitTestSource = null;
        let hitTestSourceRequested = false;

        let googleMap; // To hold the Google Map instance
        let allPinData = []; // Holds data for all pins (loaded and new)
        let arPinsInScene = []; // Holds Three.js objects for pins in the current AR session
        let arReady = false; // Flag to check if AR has been initialized

        // --- APPLICATION INITIALIZATION ---
        // We attach our main function to the window object so the Google Maps callback can find it.
        window.initApp = () => {
            initMap();
            watchGPS();
            setupEnterARButton();
        };

        // --- MAP FUNCTIONS ---
        function initMap() {
            // Default location set to Limerick, Ireland
            const initialLocation = { lat: 52.6638, lng: -8.6267 }; 
            googleMap = new google.maps.Map(document.getElementById("map"), {
                center: initialLocation,
                zoom: 18,
                // UPDATED: Changed map type from 'satellite' to 'roadmap' for the simple view
                mapTypeId: 'roadmap', 
                disableDefaultUI: true,
                gestureHandling: 'greedy'
            });
            updateStatus("Map initialized. Loading saved pins.");
            loadPinsFromLocalStorage();
        }

        // --- UI SETUP ---
        function setupEnterARButton() {
            const enterARButton = document.getElementById('enter-ar-button');
            enterARButton.addEventListener('click', () => {
                // Switch views from Map to AR
                document.getElementById('map-container').style.display = 'none';
                document.getElementById('ar-container').style.display = 'block';

                // Initialize AR on the first click only
                if (!arReady) {
                    initAR();
                    arReady = true;
                }
                
                // Programmatically click the hidden Three.js AR button to start the WebXR session
                document.getElementById('ar-button').click();
            });
        }

        // --- AR INITIALIZATION ---
        function initAR() {
            const arContainer = document.getElementById('ar-container');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 40);

            // Add basic lighting to the scene
            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1.5);
            light.position.set(0.5, 1, 0.25);
            scene.add(light);

            // Setup the renderer for WebXR
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            arContainer.appendChild(renderer.domElement);

            // Create the real AR button from Three.js but keep it hidden. We trigger it with our own button.
            const arButton = ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] });
            document.body.appendChild(arButton);

            // Create the reticle (the circle that shows where you can place an object)
            reticle = new THREE.Mesh(
                new THREE.RingGeometry(0.08, 0.1, 32).rotateX(-Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0x4A90E2 })
            );
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);

            // Setup the controller for tap events
            controller = renderer.xr.getController(0);
            controller.addEventListener('select', onSelect);
            scene.add(controller);

            window.addEventListener('resize', onWindowResize);
            // Start the render loop
            renderer.setAnimationLoop(render);
        }

        // --- LOCAL STORAGE & PIN MANAGEMENT ---
        function savePinsToLocalStorage() {
            localStorage.setItem('ar_gps_pins', JSON.stringify(allPinData));
            updateStatus(`${allPinData.length} pins saved to browser cache.`);
        }

        function loadPinsFromLocalStorage() {
            const savedPinsJSON = localStorage.getItem('ar_gps_pins');
            if (savedPinsJSON) {
                allPinData = JSON.parse(savedPinsJSON);
                updateStatus(`Loaded ${allPinData.length} pins from cache.`);
                // Add markers on the map for each loaded pin
                allPinData.forEach(pinData => {
                    placeMarkerOnMap(pinData);
                });
            } else {
                updateStatus("No pins found in cache. Place a new one in AR!");
            }
        }

        // --- CORE AR + GPS LOGIC ---
        function onSelect() {
            // This function is called when the user taps the screen in AR mode
            if (reticle.visible) {
                updateStatus("Getting precise location...");
                // Get high-accuracy GPS coordinates for the new pin
                navigator.geolocation.getCurrentPosition((position) => {
                    const { latitude, longitude, altitude } = position.coords;
                    const pinData = {
                        lat: latitude,
                        lon: longitude,
                        alt: altitude || 0, // Use 0 if altitude is not available
                        id: `pin_${Date.now()}`, // Unique ID for the pin
                        createdAt: Date.now()
                    };
                    
                    allPinData.push(pinData);
                    savePinsToLocalStorage();

                    // Get the 3D position from the reticle and place the pin
                    const pinPosition = new THREE.Vector3().setFromMatrixPosition(reticle.matrix);
                    placePinInScene(pinPosition, pinData, true); // `true` for new pin color
                    placeMarkerOnMap(pinData);

                }, (error) => {
                    console.error("GPS Error:", error);
                    updateStatus(`Error getting location: ${error.message}`);
                }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
            }
        }

        function placePinInScene(position, data, isNew) {
            // Creates the 3D model for the pin
            const geometry = new THREE.CylinderGeometry(0.01, 0.08, 0.4, 32);
            const material = new THREE.MeshStandardMaterial({
                color: isNew ? 0xff3366 : 0xffff00, // Red for new, Yellow for old
                metalness: 0.4,
                roughness: 0.6
            });
            const pin = new THREE.Mesh(geometry, material);
            
            pin.position.copy(position);
            pin.position.y += 0.2; // Raise the pin slightly so it sits on the surface
            
            pin.userData = data; // Store GPS data with the 3D object
            scene.add(pin);
            arPinsInScene.push(pin);
        }

        function placeMarkerOnMap(data) {
            // Places a standard Google Maps marker
            if (!googleMap) return;
            const marker = new google.maps.Marker({
                position: { lat: data.lat, lng: data.lon },
                map: googleMap,
                title: `Pin placed at ${new Date(data.createdAt).toLocaleString()}`,
                animation: google.maps.Animation.DROP,
            });
        }

        // --- GEOLOCATION ---
        function watchGPS() {
            if (!navigator.geolocation) {
                updateStatus("Geolocation is not supported by your browser.");
                return;
            }
            // Continuously watch the user's position
            navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    document.getElementById('coords').textContent = `Lat/Lon: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                    // Center the map on the user's location when not in AR
                    if (googleMap && !renderer?.xr.isPresenting) {
                        googleMap.setCenter({ lat: latitude, lng: longitude });
                    }
                },
                () => { updateStatus("Unable to retrieve your location."); },
                { enableHighAccuracy: true }
            );
        }

        // --- UTILITY & EVENT HANDLERS ---
        function onWindowResize() {
            if (arReady) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        }

        function updateStatus(message) {
            console.log(message);
            document.getElementById('status').textContent = message;
        }

        // --- RENDER LOOP ---
        function render(timestamp, frame) {
            if (!renderer) return; // Don't render if AR not initialized

            if (renderer.xr.isPresenting && frame) {
                const referenceSpace = renderer.xr.getReferenceSpace();
                const session = renderer.xr.getSession();

                if (!hitTestSourceRequested) {
                    session.requestReferenceSpace('viewer').then((refSpace) => {
                        session.requestHitTestSource({ space: refSpace }).then((source) => {
                            hitTestSource = source;
                        });
                    });
                    session.addEventListener('end', () => {
                        // This event is triggered when exiting AR mode
                        hitTestSourceRequested = false;
                        hitTestSource = null;

                        // Clean up AR objects from the scene to prevent duplicates
                        arPinsInScene.forEach(pin => scene.remove(pin));
                        arPinsInScene = [];

                        // Switch back to the map view
                        document.getElementById('ar-container').style.display = 'none';
                        document.getElementById('map-container').style.display = 'block';

                        // Center map on the last pin placed
                        if (allPinData.length > 0) {
                            const lastPin = allPinData[allPinData.length - 1];
                            googleMap.setCenter({ lat: lastPin.lat, lng: lastPin.lon });
                            googleMap.setZoom(20);
                        }
                        updateStatus("Exited AR. View your pins on the map.");
                    });
                    hitTestSourceRequested = true;
                }

                if (hitTestSource) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);
                    if (hitTestResults.length) {
                        const hit = hitTestResults[0];
                        reticle.visible = true;
                        // Position the reticle at the detected hit point
                        reticle.matrix.fromArray(hit.getPose(referenceSpace).transform.matrix);
                    } else {
                        reticle.visible = false;
                    }
                }
            }

            // Animate pins in the scene
            if (arReady) {
                arPinsInScene.forEach(pin => {
                    pin.rotation.y += 0.01; // Gently rotate the pins
                });
                renderer.render(scene, camera);
            }
        }
    </script>

    <!-- 
      The Google Maps script is placed AFTER the module script. 
      The 'defer' attribute ensures it runs after the page is parsed and our script is ready.
    -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDKFpUFxl8pfNSbx0GlQhmvFaHePoBxhKs&callback=initApp&libraries=geometry" defer></script>

</body>
</html>
