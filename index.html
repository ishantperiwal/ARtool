<!DOCTYPE html>
<html lang="en">
<head>
    <title>WebXR AR GPS Pins with Local Storage</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden; /* Prevent scrolling */
        }
        #ar-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            display: none; 
        }
        #map-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
        /* Info panel is a top-level overlay */
        #info-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 10;
            max-width: 300px;
            display: none; /* Hidden by default, controlled by JS */
        }
        #ar-button { display: none !important; }

        /* Loading indicator is a top-level overlay */
        #loading-indicator {
            position: fixed; 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            z-index: 99;
            display: none; /* Hidden by default */
            font-size: 1.2em;
        }
    </style>
</head>
<body class="bg-black text-white">

    <!-- The AR view will be populated by Three.js -->
    <div id="ar-container"></div>

    <!-- The Map view is the default view -->
    <div id="map-container">
        <div id="map" class="w-full h-full"></div>
        <button id="enter-ar-button" class="absolute bottom-10 left-1/2 -translate-x-1/2 z-10 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transition-transform transform hover:scale-105">
            Go Inside AR
        </button>
        <button id="delete-all-pins-button" class="absolute top-4 right-4 z-10 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg">
            Delete All Pins
        </button>
    </div>
    
    <!-- Moved info-panel and loading-indicator to be direct children of the body -->
    <div id="loading-indicator">Loading Pins...</div>
    <div id="info-panel">
        <p id="status">Welcome! Loading map...</p>
        <p id="coords">Lat/Lon: N/A</p>
        <p id="reticle-coords">Reticle (X, Z): N/A</p>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.148.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.148.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        // Three.js Imports
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/webxr/ARButton.js';

        // --- GLOBAL VARIABLES ---
        let camera, scene, renderer;
        let controller;
        let reticle;
        let hitTestSource = null;
        let hitTestSourceRequested = false;

        let googleMap;
        let allPinData = [];
        let arPinsInScene = [];
        let arReady = false;

        let deviceHeading = 0;

        // --- APPLICATION INITIALIZATION ---
        window.initApp = () => {
            initMap();
            watchGPS();
            setupEnterARButton();
            setupDeleteButton(); 
            setupDeviceOrientation();
        };

        // --- MAP FUNCTIONS ---
        function initMap() {
            // Using a location in Limerick, Ireland as a default
            const initialLocation = { lat: 52.6638, lng: -8.6267 }; 
            googleMap = new google.maps.Map(document.getElementById("map"), {
                center: initialLocation,
                zoom: 18,
                mapTypeId: 'roadmap', 
                disableDefaultUI: true,
                gestureHandling: 'greedy'
            });
            updateStatus("Map initialized. Loading saved pins.");
            loadPinsFromLocalStorage();
        }

        // --- UI SETUP ---
        function setupEnterARButton() {
            const enterARButton = document.getElementById('enter-ar-button');
            enterARButton.addEventListener('click', () => {
                document.getElementById('map-container').style.display = 'none';
                document.getElementById('ar-container').style.display = 'block';
                
                // The info panel is now shown inside the render loop, not here.

                if (!arReady) {
                    initAR();
                    arReady = true;
                }
                
                placeExistingPinsInAR();
                
                // This programmatically clicks the hidden Three.js AR button
                document.getElementById('ar-button').click();
            });
        }
        
        function setupDeleteButton() {
            const deleteButton = document.getElementById('delete-all-pins-button');
            deleteButton.addEventListener('click', () => {
                if (confirm("Are you sure you want to delete all saved pins? This cannot be undone.")) {
                    deleteAllPins();
                }
            });
        }

        // --- AR & SENSOR INITIALIZATION ---
        function setupDeviceOrientation() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                        } else {
                            updateStatus("Permission for device orientation not granted.");
                        }
                    })
                    .catch(console.error);
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        function handleOrientation(event) {
            // webkitCompassHeading is for iOS. alpha is the standard.
            const heading = event.webkitCompassHeading || event.alpha;
            if (heading !== null) {
                deviceHeading = heading;
            }
        }

        function initAR() {
            const arContainer = document.getElementById('ar-container');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 40);

            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1.5);
            light.position.set(0.5, 1, 0.25);
            scene.add(light);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            arContainer.appendChild(renderer.domElement);

            const arButton = ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] });
            document.body.appendChild(arButton);

            reticle = new THREE.Mesh(
                new THREE.RingGeometry(0.08, 0.1, 32).rotateX(-Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0x4A90E2 })
            );
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);

            controller = renderer.xr.getController(0);
            controller.addEventListener('select', onSelect);
            scene.add(controller);

            window.addEventListener('resize', onWindowResize);
            renderer.setAnimationLoop(render);
        }

        // --- LOCAL STORAGE & PIN MANAGEMENT ---
        function savePinsToLocalStorage() {
            localStorage.setItem('ar_gps_pins', JSON.stringify(allPinData));
            updateStatus(`${allPinData.length} pins saved to local storage.`);
        }

        function loadPinsFromLocalStorage() {
            const savedPinsJSON = localStorage.getItem('ar_gps_pins');
            if (savedPinsJSON) {
                allPinData = JSON.parse(savedPinsJSON);
                updateStatus(`Loaded ${allPinData.length} pins from local storage.`);
                allPinData.forEach(pinData => placeMarkerOnMap(pinData));
            } else {
                updateStatus("No pins found in local storage. Place a new one in AR!");
            }
        }
        
        function deleteAllPins() {
            allPinData = [];
            localStorage.removeItem('ar_gps_pins');
            updateStatus("All pins have been deleted.");
            // Reload to clear map markers and state
            location.reload();
        }

        // --- CORE AR + GPS LOGIC ---
        function placeExistingPinsInAR() {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.style.display = 'block';
            updateStatus("Locating you to place saved pins...");

            navigator.geolocation.getCurrentPosition(position => {
                const userLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                
                updateStatus(`Found you! Placing ${allPinData.length} saved pins.`);

                allPinData.forEach(pinData => {
                    const pinLocation = new google.maps.LatLng(pinData.lat, pinData.lon);

                    const distance = google.maps.geometry.spherical.computeDistanceBetween(userLocation, pinLocation);
                    const pinHeading = google.maps.geometry.spherical.computeHeading(userLocation, pinLocation);
                    
                    const relativeHeading = pinHeading - deviceHeading;
                    
                    const x = distance * Math.sin(relativeHeading * Math.PI / 180);
                    const z = -distance * Math.cos(relativeHeading * Math.PI / 180);

                    const pinPosition = new THREE.Vector3(x, 0, z);
                    placePinInScene(pinPosition, pinData, false);
                });
                
                loadingIndicator.style.display = 'none';

            }, (error) => {
                console.error("GPS Error:", error);
                updateStatus(`Could not get your location to place saved pins: ${error.message}`);
                loadingIndicator.style.display = 'none';
            }, { enableHighAccuracy: true });
        }

        function onSelect() {
            if (reticle.visible) {
                updateStatus("Getting precise location to save new pin...");
                navigator.geolocation.getCurrentPosition((position) => {
                    const { latitude, longitude, altitude } = position.coords;
                    const pinData = {
                        lat: latitude,
                        lon: longitude,
                        alt: altitude || 0,
                        id: `pin_${Date.now()}`,
                        createdAt: Date.now()
                    };
                    
                    allPinData.push(pinData);
                    savePinsToLocalStorage();

                    const pinPosition = new THREE.Vector3().setFromMatrixPosition(reticle.matrix);
                    placePinInScene(pinPosition, pinData, true); 
                    placeMarkerOnMap(pinData);

                }, (error) => {
                    console.error("GPS Error:", error);
                    updateStatus(`Error getting location: ${error.message}`);
                }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
            }
        }

        function placePinInScene(position, data, isNew) {
            // Avoid placing duplicate pins in the AR scene
            if (arPinsInScene.some(p => p.userData.id === data.id)) return;

            const geometry = new THREE.CylinderGeometry(0.01, 0.08, 0.4, 32);
            const material = new THREE.MeshStandardMaterial({
                color: isNew ? 0xff3366 : 0xffff00, // Red for new, Yellow for old
                metalness: 0.4,
                roughness: 0.6
            });
            const pin = new THREE.Mesh(geometry, material);
            
            pin.position.copy(position);
            pin.position.y += 0.2; // Lift the pin so its base is on the ground
            
            pin.userData = data; 
            scene.add(pin);
            arPinsInScene.push(pin);
        }

        function placeMarkerOnMap(data) {
            if (!googleMap) return;

            const starIcon = {
                path: 'M 12,2.5 L 14.3,7.7 L 20,8.5 L 16,12.3 L 17,18 L 12,15.2 L 7,18 L 8,12.3 L 4,8.5 L 9.7,7.7 Z',
                fillColor: '#FFD700',
                fillOpacity: 1,
                strokeWeight: 0,
                rotation: 0,
                scale: 1.5,
                anchor: new google.maps.Point(12, 12)
            };

            new google.maps.Marker({
                position: { lat: data.lat, lng: data.lon },
                map: googleMap,
                icon: starIcon,
                title: `Pin placed at ${new Date(data.createdAt).toLocaleString()}`,
                animation: google.maps.Animation.DROP,
            });
        }

        // --- GEOLOCATION ---
        function watchGPS() {
            if (!navigator.geolocation) {
                updateStatus("Geolocation is not supported by your browser.");
                return;
            }
            navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    document.getElementById('coords').textContent = `Lat/Lon: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                    // Only recenter the map if we are not in AR mode
                    if (googleMap && !renderer?.xr.isPresenting) {
                        googleMap.setCenter({ lat: latitude, lng: longitude });
                    }
                },
                () => { updateStatus("Unable to retrieve your location."); },
                { enableHighAccuracy: true }
            );
        }

        // --- UTILITY & EVENT HANDLERS ---
        function onWindowResize() {
            if (arReady) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        }

        function updateStatus(message) {
            console.log(message);
            document.getElementById('status').textContent = message;
        }

        // --- RENDER LOOP ---
        function render(timestamp, frame) {
            if (!renderer) return; 

            if (renderer.xr.isPresenting && frame) {
                // *** FIXED HERE ***
                // This ensures the info panel is visible during an active AR session.
                const infoPanel = document.getElementById('info-panel');
                if (infoPanel.style.display !== 'block') {
                    infoPanel.style.display = 'block';
                }

                const referenceSpace = renderer.xr.getReferenceSpace();
                const session = renderer.xr.getSession();

                if (!hitTestSourceRequested) {
                    session.requestReferenceSpace('viewer').then((refSpace) => {
                        session.requestHitTestSource({ space: refSpace }).then((source) => {
                            hitTestSource = source;
                        });
                    });
                    session.addEventListener('end', () => {
                        hitTestSourceRequested = false;
                        hitTestSource = null;

                        // Clean up AR scene
                        arPinsInScene.forEach(pin => scene.remove(pin));
                        arPinsInScene = [];

                        // Switch back to map view
                        document.getElementById('ar-container').style.display = 'none';
                        document.getElementById('map-container').style.display = 'block';
                        // Manually hide the info panel when exiting AR
                        document.getElementById('info-panel').style.display = 'none';

                        // Recenter map on the last pin placed
                        if (allPinData.length > 0) {
                            const lastPin = allPinData[allPinData.length - 1];
                            googleMap.setCenter({ lat: lastPin.lat, lng: lastPin.lon });
                            googleMap.setZoom(20);
                        }
                        updateStatus("Exited AR. View your pins on the map.");
                    });
                    hitTestSourceRequested = true;
                }

                if (hitTestSource) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);
                    const reticleCoordsEl = document.getElementById('reticle-coords');

                    if (hitTestResults.length) {
                        const hit = hitTestResults[0];
                        reticle.visible = true;
                        reticle.matrix.fromArray(hit.getPose(referenceSpace).transform.matrix);

                        const reticlePosition = new THREE.Vector3().setFromMatrixPosition(reticle.matrix);
                        reticleCoordsEl.textContent = `Reticle (X, Z): ${reticlePosition.x.toFixed(2)}, ${reticlePosition.z.toFixed(2)}`;

                    } else {
                        reticle.visible = false;
                        reticleCoordsEl.textContent = 'Reticle (X, Z): N/A';
                    }
                }
            }

            if (arReady) {
                // Simple animation for the pins
                arPinsInScene.forEach(pin => {
                    pin.rotation.y += 0.01; 
                });
                renderer.render(scene, camera);
            }
        }
    </script>

    <!-- IMPORTANT: Replace YOUR_API_KEY with your actual Google Maps API key -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDKFpUFxl8pfNSbx0GlQhmvFaHePoBxhKs&callback=initApp&libraries=geometry" defer></script>

</body>
</html>
